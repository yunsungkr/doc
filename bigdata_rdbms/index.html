<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <title>Hybrid App Ionic</title>
    <link rel="stylesheet" href="../reveal/css/reveal.css">
    <link rel="stylesheet" href="../reveal/css/theme/black.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="../reveal/lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>
</head>

<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <h1>대용량 데이터베이스</h1>
                <br />
                <br />
                <p>
                    <small>RDBMS Oracle 대용량 데이터 파싱</small>
                </p>
            </section>

            <section>
                <h3>목차</h3>
                <div style="text-align:left">
                    <p>1. Data Type</p>
                    <p>2. Oracle Load, ODP.NET API</p>
                    <p>3. Memory Limit</p>
                    <p>4. Implementation</p>
                    <p>5. Direct Path Load</p>
                    <p>6. 그밖의 Tips</p>
                </div>
            </section>
            <section>
                <section>
                    <h3>Data Type</h3>
                </section>
                <section>
                    <h3>Small Text File</h3>
                    <p>'Key, Value, Value, Value...'</p>
                    <p>400 values, 3KB * 5,000rows = 15MB</p>
                    <br />
                        <table>
                            <tbody>
                                <tr>
                                    <td>PIVOT</td>
                                    <td style="text-align:right">2,000,000</td>
                                    <td style="text-align:right">2시간</td>
                                </tr>
                                <tr>
                                    <td>UNPIVOT</td>
                                    <td style="text-align:right">5,000</td>
                                    <td style="text-align:right">11분</td>
                                </tr>
                                <tr>
                                    <td>UNPIVOT(clob)</td>
                                    <td style="text-align:right">1</td>
                                    <td style="text-align:right">7분</td>
                                </tr>
                            </tbody>
                        </table>
                </section>
                <section>
                    <h3>Large Text File</h3>
                    <p>300MB, 500Byte * 16,000,000rows = 7.45GB</p>
                </section>    
            </section>
            <section>
                <section>
                    <h3>Oracle Load, ODP.NET API</h3>
                </section>
                <section>
                    <p style="font-size:50px">Conventional path load vs. Direct path load</p>
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>Lock</th>
                                <th>DML</th>
                                <th>Transaction</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Conventional</td>
                                <td>Row</td>
                                <td style="text-align:center">O</td>
                                <td style="text-align:center">O</td>
                            </tr>
                            <tr>
                                <td>Direct</td>
                                <td>Talbe</td>
                                <td style="text-align:center">X</td>
                                <td style="text-align:center">X</td>
                            </tr>
                        </tbody>
                    </table>
                </section>
                <section>
                    <p style="font-size:50px">Direct path load DML Hint</p>
                    <pre><code class="hljs" data-trim contenteditable>
INSERT /** append_values */ INTO DATA_TABLE                
                    </code></pre>
                </section>       
                <section>
                    <p style="font-size:50px">Oracle.DataAccess.Client.OracleBulkCopy</p>
                        <pre><code class="hljs" data-trim contenteditable>
using (Oracle.DataAccess.Client.OracleBulkCopy bulkcopy = new Oracle.DataAccess.Client.OracleBulkCopy(GetConnection()))
{
    bulkcopy.BulkCopyTimeout = 0;
    bulkcopy.DestinationTableName = TableName;
    //bulkcopy.DestinationPartitionName = PartitionName;
    
    bulkcopy.WriteToServer(table);
    //bulkcopy.WriteToServer(reader);
}
                        </code></pre>
                </section>
            </section>
            
            <section>
                <section>
                    <h3>Memory Limit</h3>
                </section>
                <section>
                    <h3>Virtual Memory</h3>
                    <ul>
                        <li>x86 : 2GB</li>
                        <li>x64 : 128TB</li>
                    </ul>
                    <p><a href="https://msdn.microsoft.com/ko-kr/library/windows/desktop/aa366778(v=vs.85).aspx#memory_limits">Memory Limits</a> for Windows.</p>
                </section>

                <section>
                    <h3>LargeAddressAware(for x86)</h3>
                    <ul>
                        <li>Post-Build event</li>
                    </ul>
                    <pre><code class="hljs" data-trim contenteditable>
call "$(DevEnvDir)..\Tools\vsvars32.bat"
editbin /largeaddressaware "$(TargetPath)"
                    </code></pre>

                    <p>Reference <a href="http://softwaremaniacs.org/soft/highlight/en/description/">link</a>.</p>
                </section>

                <section>
                    <h3>CLR Large Object Size Limit</h3>
                    <ul>
                        <li>Array object size limit 2GB</li>
                        <li>gcAllowVeryLargeObjects(for x64, .net4.5)</li>
                    </ul>
                    <pre><code class="hljs" data-trim contenteditable>
&lt;runtime&gt;
    &lt;gcAllowVeryLargeObjects enabled="true"/&gt;
&lt;/runtime&gt;
                    </code></pre>                         
                </section>
            </section>
            
            <section>
                <section>
                    <h3>Implementation</h3>
                </section>
                <section>
                    <p style="font-size:50px">DataTable vs. DataReader</p>
                    <ul>
                        <li>ReadOnly</li>
                        <li>Cache</li>
                        <li>Serialization</li>
                    </ul>
                </section>
                <section>
                    <p>Implement IDataReader</p>
                        <pre><code class="hljs" data-trim contenteditable>
public abstract class CustomReader&lt;T&gt; : IDataReader {
    public StreamReader FileReader { get; set; }
    public T LineData { get; set; }
    private PropertyInfo[] _propertis = null;

    public abstract bool Read();

    public object GetValue(int i) {
        return GetPropertyValue(i);
    }
    private object GetPropertyValue(int i) {
        return _propertis[i].GetValue(LineData, null);
    }
}
                        </code></pre>
                </section>
                <section>
                    <p>Inheritance CustomReader</p>
                        <pre><code class="hljs" data-trim contenteditable>
public class ADataReader : CustomReader&lt;A&gt; {
    public override bool Read() {
        var result = !FileReader.EndOfStream;
        if (result) {
            string strLine = FileReader.ReadLine();
            // do something
        }
        return result;
    }
}
                        </code></pre>
                </section>
                <section>
                    <p style="font-size:50px">OracleBulkCopy.BatchSize</p>
                        <ul>
                            <li>Commit(Index rebuild)</li>
                        </ul>
                        <pre><code class="hljs" data-trim contenteditable>
using (Oracle.DataAccess.Client.OracleBulkCopy bulkcopy = new Oracle.DataAccess.Client.OracleBulkCopy(GetConnection()))
{
    bulkcopy.BulkCopyTimeout = 0;
    bulkcopy.DestinationTableName = TableName;
    bulkcopy.BatchSize = 3,000,000;
    bulkcopy.BulkCopyOptions = OracleBulkCopyOptions.UseInternalTransaction;
    bulkcopy.WriteToServer(reader);
}
                        </code></pre>
                </section>
                <section>
                    <h3>Performance Monitor</h3>
                    <img width="" height="" data-src="img/perfmon2.png" alt="Performance Monitor">
                </section>
            </section>
            
            <section>
                <section>
                    <h3>Direct path load</h3>
                </section>
                <section>
                <h3>Direct path load Feature</h3>
                <ul>
                    <li>Index Rebuild per load(per batch)</li>
                    <li>Index Unusable State</li>
                    <li>Local Index Partition(Partition Lock)</li>
                </ul>
                </section>
                
                <section>
                <h3>MemoryMappedFile</h3>
                <pre><code class="hljs" data-trim contenteditable>
using (MemoryMappedFile mmf = MemoryMappedFile.CreateFromFile(filePath, FileMode.Open, "FULL"))
{
    MemoryMappedViewStream mmvs1 = mmf.CreateViewStream(0, half);
    MemoryMappedViewStream mmvs2 = mmf.CreateViewStream(half, end);

    StreamReader reader1 = new StreamReader(mmvs1);
    StreamReader reader2 = new StreamReader(mmvs2);

    BulkItem item1 = new BulkItem() {
        AReader1 = new ADataReader(reader1),
        TableName = TABLE_NAME,
        PartitionName = "PARTITION_A"
    };
    BulkItem item2 = new BulkItem() {
        AReader2 = new ADataReader(reader2),
        TableName = TABLE_NAME,
        PartitionName = "PARTITION_B"
    };
    
    List&lt;BulkItem&gt; lstItem = new List&lt;BulkItem&gt;();
    lstItem.Add(item1);
    lstItem.Add(item2);
    
    Parallel.ForEach(lstItem, item => {
        //
    });
    ...
                </code></pre>
                    
                </section>
            </section>
         
            <section>
                <section>
                    <h3>Tips</h3>
                </section>
                <section>
                    <h3>Thread Safe</h3>
                </section>
                <section>
                    <h3>Regex</h3>
                    <p><a href="https://regex101.com/">link</a></p>
                </section>
                <section>
                    <h3>Generic Interface</h3>
                </section>
                <section>
                    <h3>wpf print</h3>
                </section>
            </section>
            <section>
                <section>
                    <h3>End</h3>
                    <p style="font-size:50px">Reference</p>
                </section>
            </section>
                           
        </div>
    </div>
    <script src="../reveal/lib/js/head.min.js"></script>
    <script src="../reveal/js/reveal.js"></script>

    <script>
        // Full list of configuration options available at:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize({
            controls: true,
            progress: true,
            history: true,
            center: true,
            transition: 'slide', // none/fade/slide/convex/concave/zoom
            // Optional reveal.js plugins
            dependencies: [{
                src: '../reveal/lib/js/classList.js',
                condition: function() {
                    return !document.body.classList;
                }
            }, {
                src: '../reveal/plugin/markdown/marked.js',
                condition: function() {
                    return !!document.querySelector('[data-markdown]');
                }
            }, {
                src: '../reveal/plugin/markdown/markdown.js',
                condition: function() {
                    return !!document.querySelector('[data-markdown]');
                }
            }, {
                src: '../reveal/plugin/highlight/highlight.js',
                async: true,
                callback: function() {
                    hljs.initHighlightingOnLoad();
                }
            }, {
                src: '../reveal/plugin/zoom-js/zoom.js',
                async: true
            }, {
                src: '../reveal/plugin/notes/notes.js',
                async: true
            }]
        });
    </script>

</body>

</html>